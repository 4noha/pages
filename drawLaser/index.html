<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Title</title>
<style>
html, body {
  height: 100%;
  margin: 0;
  background-color: black;
}

#canvas {
  position: relative;
  left: 50%;
  top: 50%;
  margin-left: -640px; // canvas の width/2
  margin-top: -360px; // canvas の height/2
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function () {
  var canvas = document.getElementById('canvas');
  var styles = canvas.getAttribute('style') || '';
  var context = canvas.getContext('2d');

  // canvasが見えるように、色を付けます
  //context.fillStyle = '#000000';
  //context.fillRect(0, 0, canvas.width, canvas.height);

  var onResize = canvas => {
    var scale = Math.min(window.innerWidth / canvas.width, window.innerHeight / canvas.height);
    var transform = 'scale(' + scale + ',' + scale + ');';

    canvas.setAttribute('style', styles + 
      '    -moz-transform: ' + transform + 
      '     -ms-transform: ' + transform + 
      '      -o-transform: ' + transform + 
      '         transform: ' + transform + 
      ' -webkit-transform-origin: center center;' +
      '    -moz-transform-origin: center center;' +
      '     -ms-transform-origin: center center;' +
      '      -o-transform-origin: center center;' +
      '         transform-origin: center center;'
    );
  }

  onResize(canvas);
  window.addEventListener('resize', () => onResize(canvas), false);

  a=`
%
(Header)
(Generated by gcodetools from Inkscape.)
(Using default header. To add your own header create file "header" in the output dir.)
M3
(Header end.)
G21 (All units in mm)

(Start cutting path id: text1)
(Change tool to Default tool)

G00 Z5.000000
G00 X333.897408 Y862.935145

G01 Z-0.125000 F100.0(Penetrate)
G01 X324.328291 Y862.935145 Z-0.125000 F400.000000
G01 X317.707004 Y883.495415 Z-0.125000
G01 X288.500790 Y883.495415 Z-0.125000
G01 X281.879503 Y862.935145 Z-0.125000
G01 X272.763893 Y862.935145 Z-0.125000
G01 X297.344287 Y936.704419 Z-0.125000
G01 X309.317022 Y936.704419 Z-0.125000
G01 X333.897408 Y862.935145 Z-0.125000
G00 Z5.000000

(End cutting path id: text1)


(Start cutting path id: text1)
(Change tool to Default tool)

G00 Z5.000000
G00 X314.940575 Y891.917699

G01 Z-0.125000 F100.0(Penetrate)
G01 X303.103893 Y928.133508 Z-0.125000 F400.000000
G01 X291.221862 Y891.917699 Z-0.125000
G01 X314.940575 Y891.917699 Z-0.125000
G00 Z5.000000

(End cutting path id: text1)


(Start cutting path id: text1)
(Change tool to Default tool)

G00 Z5.000000
G00 X379.974298 Y918.869000

G01 Z-0.125000 F100.0(Penetrate)
G03 X379.738546 Y921.494190 Z-0.125000 I-14.734145 J0.000000 F400.000000
G03 X379.157973 Y923.377396 Z-0.125000 I-8.104699 J-1.467499
G03 X378.108667 Y925.008419 Z-0.125000 I-5.823034 J-2.593161
G03 X376.527597 Y926.349970 Z-0.125000 I-5.456885 J-4.828696
G03 X374.292487 Y927.384140 Z-0.125000 I-5.164545 J-8.229512
G03 X371.357558 Y927.984881 Z-0.125000 I-4.334675 J-13.707443
G03 X368.313151 Y928.228483 Z-0.125000 I-5.123578 J-44.886139
G03 X363.829242 Y928.331718 Z-0.125000 I-4.483910 J-97.326147
G01 X353.126346 Y928.331718 Z-0.125000
G01 X353.126346 Y907.028302 Z-0.125000
G01 X364.736271 Y907.028302 Z-0.125000
G03 X368.941569 Y907.167818 Z-0.125000 I0.000000 J63.447779
G03 X371.448255 Y907.474150 Z-0.125000 I-1.514828 J22.804831
G03 X373.838282 Y908.214528 Z-0.125000 I-2.339849 J11.781141
G03 X376.074090 Y909.455864 Z-0.125000 I-4.940939 J11.533440
G03 X377.898142 Y911.179856 Z-0.125000 I-4.857903 J6.966806
G03 X379.067268 Y913.270663 Z-0.125000 I-6.086893 J4.775914
G03 X379.718903 Y915.695771 Z-0.125000 I-11.534642 J4.399500
G03 X379.974298 Y918.869000 Z-0.125000 I-19.585698 J3.173228
G01 X379.974298 Y918.869000 Z-0.125000
G00 Z5.000000

(End cutting path id: text1)


(Start cutting path id: text1)
(Change tool to Default tool)

G00 Z5.000000
G00 X385.733912 Y885.229422

G01 Z-0.125000 F100.0(Penetrate)
G03 X385.358557 Y889.605052 Z-0.125000 I-25.691729 J-0.000000 F400.000000
G03 X384.509421 Y892.314042 Z-0.125000 I-10.579200 J-1.828487
G03 X382.913403 Y894.597279 Z-0.125000 I-7.303686 J-3.405948
G03 X380.065002 Y896.772899 Z-0.125000 I-9.448524 J-9.417928
G03 X377.800238 Y897.740627 Z-0.125000 I-5.378107 J-9.452364
G03 X374.758903 Y898.358269 Z-0.125000 I-4.943445 J-16.545285
G03 X371.667545 Y898.637867 Z-0.125000 I-5.261319 J-40.941997
G03 X367.230594 Y898.754570 Z-0.125000 I-4.436951 J-84.286408
G01 X353.126346 Y898.754570 Z-0.125000
G01 X353.126346 Y871.307839 Z-0.125000
G01 X365.008377 Y871.307839 Z-0.125000
G03 X370.887417 Y871.503605 Z-0.125000 I-0.000000 J88.374129
G03 X374.668198 Y871.951880 Z-0.125000 I-2.462851 J36.939738
G03 X378.278909 Y872.998224 Z-0.125000 I-3.417055 J18.544586
G03 X380.835971 Y874.429023 Z-0.125000 I-4.269627 J10.630829
G03 X383.101796 Y876.583702 Z-0.125000 I-8.631665 J11.345609
G03 X384.554777 Y878.838332 Z-0.125000 I-8.019363 J6.763522
G03 X385.383128 Y881.394705 Z-0.125000 I-9.293765 J4.423887
G03 X385.733912 Y885.229363 Z-0.125000 I-20.784236 J3.834658
G01 X385.733912 Y885.229422 Z-0.125000
G00 Z5.000000

(End cutting path id: text1)


(Start cutting path id: text1)
(Change tool to Default tool)

G00 Z5.000000
G00 X395.076271 Y885.625765

G01 Z-0.125000 F100.0(Penetrate)
G02 X394.552969 Y880.239352 Z-0.125000 I-27.983112 J-0.000000 F400.000000
G02 X393.171516 Y875.915365 Z-0.125000 I-19.319540 J3.789648
G02 X390.874659 Y872.000223 Z-0.125000 I-19.585950 J8.858985
G02 X388.046826 Y868.979373 Z-0.125000 I-14.367516 J10.615507
G02 X383.991792 Y866.157170 Z-0.125000 I-15.910830 J18.536894
G02 X379.656836 Y864.322341 Z-0.125000 I-10.763054 J19.390441
G02 X375.059457 Y863.351518 Z-0.125000 I-7.755011 J25.353268
G02 X368.092267 Y862.935145 Z-0.125000 I-6.967190 J58.083069
G01 X344.146797 Y862.935145 Z-0.125000
G01 X344.146797 Y936.704419 Z-0.125000
G01 X364.146704 Y936.704419 Z-0.125000
G02 X371.523042 Y936.506419 Z-0.125000 I0.000000 J-137.498967
G02 X375.212417 Y936.109926 Z-0.125000 I-1.865260 J-34.719393
G02 X378.776234 Y935.201356 Z-0.125000 I-3.298516 J-20.381965
G02 X382.241863 Y933.632783 Z-0.125000 I-7.341616 J-20.833466
G02 X385.528730 Y931.094908 Z-0.125000 I-7.541211 J-13.164205
G02 X387.638659 Y928.133525 Z-0.125000 I-8.302129 J-8.147445
G02 X388.843838 Y924.701439 Z-0.125000 I-12.487419 J-6.312605
G02 X389.316657 Y920.157132 Z-0.125000 I-21.601443 J-4.544307
G02 X388.639676 Y915.108618 Z-0.125000 I-19.162862 J0.000000
G02 X386.867691 Y911.189879 Z-0.125000 I-13.178367 J3.599026
G02 X384.048817 Y907.928088 Z-0.125000 I-14.519131 J9.698636
G02 X380.337108 Y905.294278 Z-0.125000 I-13.040182 J14.444668
G01 X380.337108 Y904.897978 Z-0.125000
G02 X386.563342 Y902.379663 Z-0.125000 I-4.508424 J-20.102513
G02 X391.130708 Y898.308789 Z-0.125000 I-8.908173 J-14.592274
G02 X393.967812 Y892.920516 Z-0.125000 I-13.134985 J-10.357055
G02 X395.076271 Y885.625824 Z-0.125000 I-23.448697 J-7.294692
G01 X395.076271 Y885.625765 Z-0.125000
G00 Z5.000000

(End cutting path id: text1)


(Start cutting path id: text1)
(Change tool to Default tool)

G00 Z5.000000
G00 X459.973933 Y868.285767

G01 Z-0.125000 F100.0(Penetrate)
G03 X457.486993 Y867.081785 Z-0.125000 I98.523847 J-206.681016 F400.000000
G03 X455.438810 Y866.056339 Z-0.125000 I69.417269 J-141.209219
G02 X453.404144 Y865.106604 Z-0.125000 I-11.830506 J22.690771
G02 X450.178059 Y863.876458 Z-0.125000 I-23.161090 J55.895144
G02 X447.384845 Y863.035316 Z-0.125000 I-13.247181 J38.932092
G02 X444.146347 Y862.291088 Z-0.125000 I-13.564740 J51.608505
G02 X440.906328 Y861.786038 Z-0.125000 I-6.004737 J27.876608
G02 X437.026197 Y861.597499 Z-0.125000 I-3.880131 J39.832113
G02 X429.786462 Y862.196586 Z-0.125000 I-0.000000 J44.044171
G02 X423.647569 Y863.826927 Z-0.125000 I5.534684 J33.213209
G02 X418.080473 Y866.726576 Z-0.125000 I9.611463 J25.247264
G02 X413.216779 Y870.911547 Z-0.125000 I15.860038 J23.350967
G02 X409.494445 Y875.993564 Z-0.125000 I20.273457 J18.753562
G02 X406.414091 Y882.851375 Z-0.125000 I34.176073 J19.471736
G02 X404.650042 Y890.246246 Z-0.125000 I39.990924 J13.447687
G02 X403.965116 Y899.745473 Z-0.125000 I65.529831 J9.499227
G02 X404.613691 Y908.757620 Z-0.125000 I62.937616 J-0.000000
G02 X406.323386 Y916.045070 Z-0.125000 I42.749600 J-6.185128
G02 X409.318245 Y922.860728 Z-0.125000 I36.586296 J-12.010522
G02 X413.126075 Y928.183065 Z-0.125000 I25.957291 J-14.547655
G02 X417.856503 Y932.393721 Z-0.125000 I20.987639 J-18.815885
G02 X423.511516 Y935.515400 Z-0.125000 I16.912855 J-23.955190
G02 X429.767686 Y937.367414 Z-0.125000 I12.035231 J-29.162653
G02 X437.071545 Y938.042083 Z-0.125000 I7.303859 J-39.197845
G02 X442.467115 Y937.686039 Z-0.125000 I0.000000 J-41.060849
G02 X447.910501 Y936.605340 Z-0.125000 I-5.683335 J-42.875734
G02 X453.208270 Y934.806086 Z-0.125000 I-10.313836 J-39.067384
G02 X459.973933 Y931.551973 Z-0.125000 I-28.109292 J-67.102695
G01 X459.973933 Y919.909409 Z-0.125000
G01 X459.293669 Y919.909409 Z-0.125000
G03 X453.408797 Y924.535054 Z-0.125000 I-33.817584 J-36.967386
G03 X448.227955 Y927.340831 Z-0.125000 I-17.306295 J-25.769831
G03 X442.617947 Y929.067013 Z-0.125000 I-11.171165 J-26.326540
G03 X436.481978 Y929.669348 Z-0.125000 I-6.135969 J-30.952309
G03 X431.461756 Y929.176792 Z-0.125000 I-0.000000 J-25.829808
G03 X427.230322 Y927.836262 Z-0.125000 I3.887119 J-19.618441
G03 X423.472251 Y925.618950 Z-0.125000 I7.232590 J-16.551741
G03 X419.928763 Y922.237925 Z-0.125000 I13.846946 J-18.059702
G03 X417.269600 Y918.265126 Z-0.125000 I16.643436 J-14.016504
G03 X415.030830 Y912.824781 Z-0.125000 I29.230948 J-15.209714
G03 X413.790241 Y907.104891 Z-0.125000 I33.935146 J-10.354690
G03 X413.307484 Y899.745473 Z-0.125000 I55.854177 J-7.359418
G03 X413.852108 Y892.057369 Z-0.125000 I54.536243 J0.000000
G03 X415.212231 Y886.368910 Z-0.125000 I31.091946 J4.427319
G03 X417.589116 Y881.017106 Z-0.125000 I33.444765 J11.650024
G03 X420.200877 Y877.253029 Z-0.125000 I19.016482 J10.406727
G03 X423.693351 Y874.024132 Z-0.125000 I16.239907 J14.062352
G03 X427.593133 Y871.803320 Z-0.125000 I11.348422 J15.393562
G03 X431.942787 Y870.512259 Z-0.125000 I8.755720 J21.525852
G03 X436.572682 Y870.069322 Z-0.125000 I4.629895 J23.976021
G03 X442.928990 Y870.697900 Z-0.125000 I-0.000000 J32.452428
G03 X448.726818 Y872.496917 Z-0.125000 I-5.741443 J28.745432
G03 X454.057037 Y875.429812 Z-0.125000 I-12.186275 J28.457231
G03 X459.339017 Y879.779713 Z-0.125000 I-22.158064 J32.287848
G01 X459.973925 Y879.779713 Z-0.125000
G01 X459.973933 Y868.285767 Z-0.125000
G00 Z5.000000

(End cutting path id: text1)


(Footer)
M5
G00 X0.0000 Y0.0000
M2
(Using default footer. To add your own footer create file "footer" in the output dir.)
(end)
%
  `;
  //console.log(a);
  a = a.split('\n');

  // strのポインタを進めながら、数値を取得する
  var getNum = function(str, ptr) {
    let num = '';
    ptr++;
    for(;/[-.\d]/.test(str[ptr]);ptr++) {
      num += str[ptr];
    }
    return [parseFloat(num), ptr];
  }

  // gcode(文字列)を配列に変換する
  var perseGcode = function(strs) {
    cmds = [];
    for(let i=0;i<strs.length;i++) {
      if (/G0[01]/.test(strs[i])) {
        console.log(strs[i]);
        let cmd = [];
        let ptr = 0;
        let x, y, z;
        if((ptr = strs[i].indexOf('X')) != -1){
          [x, ptr] = getNum(strs[i], ptr);
        }
        if((ptr = strs[i].indexOf('Y')) != -1){
          [y, ptr] = getNum(strs[i], ptr);
        }
        if((ptr = strs[i].indexOf('Z')) != -1){
          [z, ptr] = getNum(strs[i], ptr);
        }
        cmds.push(['G00', x, y, z]);
      }
      if (/G0[23]/.test(strs[i])) {
        console.log(strs[i]);
        let cmd = [];
        let ptr = 0;
        let x, y, z, i_, j;
        if((ptr = strs[i].indexOf('X')) != -1){
          [x, ptr] = getNum(strs[i], ptr);
        }
        if((ptr = strs[i].indexOf('Y')) != -1){
          [y, ptr] = getNum(strs[i], ptr);
        }
        if((ptr = strs[i].indexOf('Z')) != -1){
          [z, ptr] = getNum(strs[i], ptr);
        }
        if((ptr = strs[i].indexOf('I')) != -1){
          [i_, ptr] = getNum(strs[i], ptr);
        }
        if((ptr = strs[i].indexOf('J')) != -1){
          [j, ptr] = getNum(strs[i], ptr);
        }
        cmds.push([strs[i].substring(0, 3), x, y, z, i_, j]);
      }
    }
    console.log(cmds);
    return cmds;
  }
  cmds = perseGcode(a);
  // 2点間の角度を求める
  let getRadian = function(x, y, x2, y2) {
      return Math.atan2(y2 - y,x2 - x);
  }
  // gcodeを一定の移動量ごとに分割する
  var splitTravel = function(cmd, sPoint, travel){
    if(cmd[3]>=0) return [[cmd], 0];
    let cmds = [];
    if(cmd[0] != 'G00'){
      for(;;){

      }
    };
    return [cmds, 0];
  }
  // gcodeを一定の移動量に分割しながら描画する
  var playCmds = async function(cmds) {
    let mag = 0.5;
    let maxX=NaN, maxY=NaN, minX=NaN, minY=NaN;
    for(let i=0;i<cmds.length;i++) {
      if (cmds[i][0] == 'G00') {
        if(isNaN(maxX) || maxX < cmds[i][1]*mag) maxX = cmds[i][1]*mag;
        if(isNaN(maxY) || maxY < cmds[i][2]*mag) maxY = cmds[i][2]*mag;
        if(isNaN(minX) || minX > cmds[i][1]*mag) minX = cmds[i][1]*mag;
        if(isNaN(minY) || minY > cmds[i][2]*mag) minY = cmds[i][2]*mag;
      }
    }
    let cmds_ = [];
    let currentPtr = [-300, -300, 5];
    for(let i=0;i<cmds.length;) {
      let splittedCmds = [];
      let mod = 0;
      if(cmds[i][0] == 'G00'){
        if(cmds[i][1] !== undefined) currentPtr[0] = cmds[i][1]*mag;
        if(cmds[i][2] !== undefined) currentPtr[1] = maxY-cmds[i][2]*mag;
        if(cmds[i][3] !== undefined) currentPtr[2] = cmds[i][3];
        //[splittedCmds, mod] = splitTravel(cmds[i], 3);
        splittedCmds = [cmds[i]];
      }
      if(/G0[23]/.test(cmds[i][0])){
        if(cmds[i][1] !== undefined) currentPtr[0] = cmds[i][1]*mag;
        if(cmds[i][2] !== undefined) currentPtr[1] = maxY-cmds[i][2]*mag;
        if(cmds[i][3] !== undefined) currentPtr[2] = cmds[i][3];
        splittedCmds = [cmds[i]];
      }
      if(currentPtr[2] >= 0){
        cmds_.push(cmds[i]);
      } else {
        for(let j=0;j<splittedCmds.length;j++){
          cmds_.push(splittedCmds[j]);
          drawGcode(cmds_, maxX, maxY, minX, minY);
          await new Promise(resolve => setTimeout(resolve, 100));
        }
      }
      i++;
    }
  }
  // gcode描画
  var drawGcode = function(cmds, maxX=NaN, maxY=NaN, minX=NaN, minY=NaN) {
    //context.fillStyle = '#ffffff';
    context.strokeStyle = '#ffffff';
    context.clearRect(0, 0, canvas.width, canvas.height);
    console.log(canvas.width, canvas.height);
    let currentPtr = [-300, -300, 5];
    let mag = 0.5;
    for(let i=0;i<cmds.length;i++) {
      if (cmds[i][0] == 'G00') {
        if(isNaN(maxX) || maxX < cmds[i][1]*mag) maxX = cmds[i][1]*mag;
        if(isNaN(maxY) || maxY < cmds[i][2]*mag) maxY = cmds[i][2]*mag;
        if(isNaN(minX) || minX > cmds[i][1]*mag) minX = cmds[i][1]*mag;
        if(isNaN(minY) || minY > cmds[i][2]*mag) minY = cmds[i][2]*mag;
      }
    }
    maxY += 300;
    //maxY = 0;
    context.beginPath();
    for(let i=0;i<cmds.length;i++) {
      if (cmds[i][0] == 'G00') {
        if(cmds[i][1] !== undefined) currentPtr[0] = cmds[i][1]*mag;
        if(cmds[i][2] !== undefined) currentPtr[1] = maxY-cmds[i][2]*mag;
        if(cmds[i][3] !== undefined) currentPtr[2] = cmds[i][3];
        if(currentPtr[2] < 0 && (cmds[i][1] || cmds[i][2])) {
          context.lineTo(currentPtr[0], currentPtr[1]);
          console.log("lineTo", currentPtr[0], currentPtr[1]);
        } else {
          console.log("moveTo", currentPtr[0], currentPtr[1]);
        }
        context.moveTo(currentPtr[0], currentPtr[1]);
      }
      if (cmds[i][0] == 'G02' || cmds[i][0] == 'G03') {
        if(cmds[i][1] !== undefined) currentPtr[0] = cmds[i][1]*mag;
        if(cmds[i][2] !== undefined) currentPtr[1] = maxY-cmds[i][2]*mag;
        if(cmds[i][3] !== undefined) currentPtr[2] = cmds[i][3];
        if(currentPtr[2] < 0) {
          console.log("bezierCurveTo", currentPtr[0], currentPtr[1], currentPtr[0], currentPtr[1], currentPtr[0], currentPtr[1]);
          context.bezierCurveTo(currentPtr[0], currentPtr[1], currentPtr[0], currentPtr[1], currentPtr[0], currentPtr[1]);
        } else {
          console.log("moveTo", currentPtr[0], currentPtr[1]);
        }
        context.moveTo(currentPtr[0], currentPtr[1]);
      }
    }
    context.closePath();
    context.stroke();
  }
  playCmds(cmds);
});
</script>
</head>
<body>
  <canvas id="canvas" width=1280 height=720 style="position: relative; left: 50%; margin-left: -640px; top: 50%; margin-top: -360px;">
  </canvas>
</body>
</html>